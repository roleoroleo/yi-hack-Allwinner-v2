#!/bin/bash

set -e

SCRIPT_DIR=$(cd `dirname $0` && pwd)
cd $SCRIPT_DIR

rm -rf ./_install

if [ ! -f crypt-1.18.2.tar.xz ]; then
    wget https://github.com/libtom/libtomcrypt/releases/download/v1.18.2/crypt-1.18.2.tar.xz
fi
tar Jxvf ./crypt-1.18.2.tar.xz
if [ ! -L libtomcrypt ]; then
    ln -s libtomcrypt-1.18.2 libtomcrypt
    cd onvif_simple_server/extras
    ln -s ../../libtomcrypt-1.18.2 libtomcrypt
    cd ../..
fi

MBEDTLS_VERSION=v3.6.5
MBEDTLS_DIR=mbedtls-3.6.5
if [ ! -f "${MBEDTLS_VERSION}.tar.gz" ]; then
    wget https://github.com/Mbed-TLS/mbedtls/archive/refs/tags/${MBEDTLS_VERSION}.tar.gz
fi
tar zxf ./${MBEDTLS_VERSION}.tar.gz
if [ ! -L mbedtls ]; then
    ln -s ${MBEDTLS_DIR} mbedtls
    cd onvif_simple_server/extras
    ln -s ../../${MBEDTLS_DIR} mbedtls
    cd ../..
fi
cp -f mbedtls_config.h mbedtls/include/mbedtls/

WOLFSSL_VERSION=v5.8.2-stable
WOLFSSL_DIR=wolfssl-5.8.2-stable
if [ ! -f "${WOLFSSL_VERSION}.tar.gz" ]; then
    wget https://github.com/wolfSSL/wolfssl/archive/refs/tags/${WOLFSSL_VERSION}.tar.gz
fi
tar zxf ./${WOLFSSL_VERSION}.tar.gz
if [ ! -L wolfssl ]; then
    ln -s ${WOLFSSL_DIR} wolfssl
    cd onvif_simple_server/extras
    ln -s ../../${WOLFSSL_DIR} wolfssl
    cd ../..
fi

if [ ! -f zlib-1.3.1.tar.gz ]; then
    wget https://www.zlib.net/zlib-1.3.1.tar.gz || \
    wget https://github.com/madler/zlib/releases/download/v1.3.1/zlib-1.3.1.tar.gz
fi
tar zxf ./zlib-1.3.1.tar.gz
if [ ! -L zlib ]; then
    ln -s zlib-1.3.1 zlib
    cd onvif_simple_server/extras
    ln -s ../../zlib-1.3.1 zlib
    cd ../..
fi

if [ ! -f json-c-0.18.tar.gz ]; then
    wget https://s3.amazonaws.com/json-c_releases/releases/json-c-0.18.tar.gz
fi
tar zxf ./json-c-0.18.tar.gz
if [ ! -L json-c ]; then
    ln -s json-c-0.18 json-c
    cd onvif_simple_server/extras
    ln -s ../../json-c-0.18 json-c
    cd ../..
fi
mkdir -p json-c/build

cd onvif_simple_server

git reset --hard

patch -p1 < ../path.patch
